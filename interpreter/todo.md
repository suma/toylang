# TODO - Interpreter Improvements

## 完了済み ✅

1. **エラーメッセージの一貫性を修正** - 各演算関数で正しい関数名を使用
2. **Enumベースのアプローチで算術演算のコード重複を解消**
3. **object.rsのパニック呼び出しをResult型に変更してエラーハンドリングを改善**
4. **unwrap_*メソッドをパニック版とtry_unwrap_*版に分離してAPIを改善**
5. **for文のUInt64とInt64処理の重複をジェネリクスで統一してパフォーマンスを改善**
6. **while文の未実装部分を完成して言語機能を完全にする**
7. **比較演算のコード重複をEnumベースアプローチで解消して保守性を向上**
8. **エラーハンドリングの明確化** ✅ (2024-06-24完了)
   - `evaluation.rs`のObject::NullをObject::Unitに変更してセマンティクスを明確化
   - while/forループ完了時、EvaluationResult::None、Return(None)処理を改善
9. **論理演算の最適化** ✅ (2024-06-24完了)
   - `evaluate_logical_and_short_circuit`と`evaluate_logical_or_short_circuit`で短絡評価を実装
   - false && expr、true || exprで右辺を評価せずにパフォーマンス向上を実現
   - 4つのテストケースを追加して動作確認済み
10. **未使用importの削除** ✅ (2024-06-24完了)
    - 警告に表示されている`RcObject`と`convert_object`の未使用importを削除
    - コンパイラ警告を解消してコードベースをクリーンアップ
11. **型チェックの改善 - AST変換機能** ✅ (2024-06-26完了)
    - frontendからinterpreterに渡すASTの段階で型変換を完了
    - `Expr::Number`を`Expr::UInt64`/`Expr::Int64`に自動変換する機能を実装
    - `TypeDecl::Number`を追加して型推論を改善
    - ExprPool/StmtPoolに`get_mut`メソッドを追加してAST変換を可能に
    - const変数（val）の型更新時も`is_const`フラグを保持
    - 自動型変換テストケースを追加

11b. **コンテキストベース型推論の改善** ✅ (2024-06-26完了)
    - 関数内で最初に見つかった明示的型宣言をグローバル型ヒントとして使用
    - `val b: i64 = 50`のような明示的宣言が`val a = 100`などの推論に影響
    - 複数操作における一貫した型推論：`(a - b) + (c - d)`で全てInt64
    - visit_valでUnknown型宣言もコンテキスト型推論を適用
    - 全40個のテストケースが通過（自動型変換テスト含む）

## 進行中 🚧

現在進行中のタスクはありません。

## 未実装 📋

12. **テストカバレッジの向上** 🧪
    - エラーケースや境界値のテストが不足している可能性があります

13. **パフォーマンス測定** 📊
    - benchmarkを追加してパフォーマンスを定量的に測定できるようにする

14. **ドキュメント整備** 📚
    - 言語仕様やAPIドキュメントの整備

## 推奨順序

次に取り組むべき課題：
1. **12番（テストカバレッジ向上）** - 品質保証の強化
2. **13番（パフォーマンス測定）** - 定量的な改善指標
3. **14番（ドキュメント整備）** - 言語仕様やAPIドキュメントの整備

## メモ

- 算術演算と比較演算は既にEnum化により統一済み
- 基本的な言語機能（if/else、for、while）は完全実装済み
- AST変換による型安全性が大幅に向上（frontendで型変換完了）
- 自動型変換機能により、型指定なしリテラルの使い勝手が向上
- **コンテキストベース型推論が完全実装済み** - 関数内の明示的型宣言が他の変数の型推論に影響
- 複雑な複数操作での一貫した型推論：`(a - b) + (c - d)`で全要素が統一型
- 全40個のテストが通過している状態を維持（プロパティベーステスト含む）