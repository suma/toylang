# TODO - Interpreter Improvements

## 完了済み ✅

1. **エラーメッセージの一貫性を修正** - 各演算関数で正しい関数名を使用
2. **Enumベースのアプローチで算術演算のコード重複を解消**
3. **object.rsのパニック呼び出しをResult型に変更してエラーハンドリングを改善**
4. **unwrap_*メソッドをパニック版とtry_unwrap_*版に分離してAPIを改善**
5. **for文のUInt64とInt64処理の重複をジェネリクスで統一してパフォーマンスを改善**
6. **while文の未実装部分を完成して言語機能を完全にする**
7. **比較演算のコード重複をEnumベースアプローチで解消して保守性を向上**
8. **エラーハンドリングの明確化** ✅ (2024-06-24完了)
   - `evaluation.rs`のObject::NullをObject::Unitに変更してセマンティクスを明確化
   - while/forループ完了時、EvaluationResult::None、Return(None)処理を改善
9. **論理演算の最適化** ✅ (2024-06-24完了)
   - `evaluate_logical_and_short_circuit`と`evaluate_logical_or_short_circuit`で短絡評価を実装
   - false && expr、true || exprで右辺を評価せずにパフォーマンス向上を実現
   - 4つのテストケースを追加して動作確認済み
10. **未使用importの削除** ✅ (2024-06-24完了)
    - 警告に表示されている`RcObject`と`convert_object`の未使用importを削除
    - コンパイラ警告を解消してコードベースをクリーンアップ
11. **型チェックの改善 - AST変換機能** ✅ (2024-06-26完了)
    - frontendからinterpreterに渡すASTの段階で型変換を完了
    - `Expr::Number`を`Expr::UInt64`/`Expr::Int64`に自動変換する機能を実装
    - `TypeDecl::Number`を追加して型推論を改善
    - ExprPool/StmtPoolに`get_mut`メソッドを追加してAST変換を可能に
    - const変数（val）の型更新時も`is_const`フラグを保持
    - 自動型変換テストケースを追加

11b. **コンテキストベース型推論の改善** ✅ (2024-06-26完了)
    - 関数内で最初に見つかった明示的型宣言をグローバル型ヒントとして使用
    - `val b: i64 = 50`のような明示的宣言が`val a = 100`などの推論に影響
    - 複数操作における一貫した型推論：`(a - b) + (c - d)`で全てInt64
    - visit_valでUnknown型宣言もコンテキスト型推論を適用
    - 包括的テストスイート（41個のテストケースが全て通過）
    - 追加テスト：単一明示的Int64宣言による他変数への影響を検証

12. **固定配列（Fixed Arrays）の実装** ✅ (2024-06-30完了)
    - 配列型宣言：`val a: [i64; 5] = [1i64, 2i64, 3i64, 4i64, 5i64]`
    - 配列リテラル：`[1i64, 2i64, 3i64]`（末尾カンマと改行サポート）
    - 配列アクセス：`a[0u64]`（読み取り・書き込み両対応）
    - 配列要素代入：`a[0u64] = 10i64`
    - AST拡張：`TypeDecl::Array`、`Expr::ArrayLiteral`、`Expr::ArrayAccess`
    - 型チェッカー：配列要素型の統一チェック、境界チェック
    - インタープリター：`Object::Array`、実行時配列操作
    - 包括的テストスイート：14個の単体テスト + 3個のプロパティベーステスト
    - エラーケース：型不一致、境界外アクセス、負インデックス
    - 実用例：フィボナッチ数列計算（example/fibonacci_array.t）

13. **行コメント機能の実装** ✅ (2024-07-05完了)
    - `#` 記号による行コメント：`# これはコメント`
    - インラインコメント：`val x = 10u64  # 変数定義`
    - Token enumに `Comment(String)` バリアント追加（linter互換性）
    - lexerに `"#".*` パターン追加でコメント内容をキャプチャ
    - パーサーで構文解析中にコメントトークンを自動スキップ
    - 包括的テストスイート：lexer・パーサー両方のテスト追加
    - 使用例：example/comment_test.t でコメント機能のデモ

14. **配列要素の型推論機能の実装** ✅ (2024-07-05完了)
    - 配列のelement_typeから自動的に要素の型を推論する機能を完全実装
    - 例：`val a: [i64; 3] = [1, 2, 3]` で `1, 2, 3` を自動的に `i64` 型と推論
    - 例：`val a: [u64; 3] = [1, 2, 3]` で `1, 2, 3` を自動的に `u64` 型と推論
    - 負数対応：`val a: [i64; 3] = [-1, -2, -3]` も正常動作
    - 型ヒント伝播システムの改善：配列リテラル内で要素型を適切に推論
    - AST変換処理：Number型から具体的型（Int64/UInt64）への自動変換
    - 包括的テストスイート：5つの配列型推論テストケース追加
    - 詳細なエラーメッセージ：型不一致時により具体的なエラー表示
    - 全68個のテストが成功（既存機能の完全な互換性維持）


## 進行中 🚧

現在進行中のタスクはありません。

## 未実装 📋

15. **配列インデックスの型推論改善** 🔍
    - 配列アクセス時のインデックス型推論の改善（`a[0]` で `0` を適切な整数型に推論）
    - より柔軟なインデックス型の自動変換

16. **テストカバレッジの向上** 🧪
    - エラーケースや境界値のテストが不足している可能性があります

17. **パフォーマンス測定** 📊
    - benchmarkを追加してパフォーマンスを定量的に測定できるようにする

18. **ドキュメント整備** 📚
    - 言語仕様やAPIドキュメントの整備

## 検討中の機能

* 動的配列
* 構造体・レコード型
* パターンマッチング
* 列挙型（Enum）
* 文字列操作
* ラムダ式・クロージャ
* Option型（Null安全性）
* モジュール・名前空間

## 推奨順序

次に取り組むべき課題：
1. **15番（配列インデックス型推論改善）** - 配列アクセスの使いやすさ向上
2. **16番（テストカバレッジ向上）** - 品質保証の強化
3. **17番（パフォーマンス測定）** - 定量的な改善指標
4. **18番（ドキュメント整備）** - 言語仕様やAPIドキュメントの整備

## メモ

- 算術演算と比較演算は既にEnum化により統一済み
- 基本的な言語機能（if/else、for、while）は完全実装済み
- AST変換による型安全性が大幅に向上（frontendで型変換完了）
- 自動型変換機能により、型指定なしリテラルの使い勝手が向上
- **コンテキストベース型推論が完全実装済み** - 関数内の明示的型宣言が他の変数の型推論に影響
- 複雑な複数操作での一貫した型推論：`(a - b) + (c - d)`で全要素が統一型
- **全68個のテストが通過している状態を維持**（プロパティベーステスト含む）
- 追加された単一明示型宣言テストにより、コンテキスト推論のカバレッジがさらに向上
- **固定配列機能が完全実装済み** - 14個の単体テスト + 3個のプロパティベーステストで品質保証
- 配列の基本構文サポート：`val a: [i64; 5] = [1i64, 2i64, 3i64, 4i64, 5i64]`、`a[0u64] = 10i64`
- **行コメント機能が完全実装済み** - `#` 記号による行コメントとインラインコメント対応
- linter互換性のためコメント内容をTokenに保存、パーサーで自動スキップ
- **配列要素の型推論機能が完全実装済み** - `val a: [i64; 3] = [1, 2, 3]` 形式の自動型推論対応
- 型ヒント伝播システムとAST変換処理により、配列リテラル内の数値型が適切に推論・変換
- 配列インデックスの型推論改善が次の目標